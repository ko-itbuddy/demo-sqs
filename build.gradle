plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.3' apply false
    id 'io.spring.dependency-management' version '1.1.7' apply false
}

// ëª¨ë“  ì„œë¸Œí”„ë¡œì íŠ¸ì— ê³µí†µ ì„¤ì • ì ìš©
allprojects {
    group = 'com.demo'
    version = '0.0.1-SNAPSHOT'
    
    repositories {
        mavenCentral()
        
        // ========================================================
        // ğŸ“¦ Nexus Repository ì„¤ì • (ì‚¬ë‚´ íŒ¨í‚¤ì§€ ì €ì¥ì†Œ)
        // ========================================================
        // ì‚¬ë‚´ Nexusë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ê³  URL ìˆ˜ì •:
        /*
        maven {
            name = "nexus-releases"
            url = "http://your-nexus-server:8081/repository/maven-public/"  // ğŸ‘ˆ íšŒì‚¬ Nexus URLë¡œ ë³€ê²½
            allowInsecureProtocol = true  // HTTP ì‚¬ìš© ì‹œ (HTTPS ê¶Œì¥)
            credentials {
                username = project.findProperty("nexusUsername") ?: System.getenv("NEXUS_USERNAME")
                password = project.findProperty("nexusPassword") ?: System.getenv("NEXUS_PASSWORD")
            }
        }
        
        maven {
            name = "nexus-snapshots"
            url = "http://your-nexus-server:8081/repository/maven-snapshots/"  // ğŸ‘ˆ íšŒì‚¬ Nexus URLë¡œ ë³€ê²½
            allowInsecureProtocol = true  // HTTP ì‚¬ìš© ì‹œ (HTTPS ê¶Œì¥)
            credentials {
                username = project.findProperty("nexusUsername") ?: System.getenv("NEXUS_USERNAME")
                password = project.findProperty("nexusPassword") ?: System.getenv("NEXUS_PASSWORD")
            }
        }
        */
        
        // ğŸ“‹ Nexus ì‚¬ìš© ì‹œ ì¶”ê°€ ì„¤ì • ì•ˆë‚´:
        // 1. gradle.propertiesì— ì¶”ê°€:
        //    nexusUsername=your-username
        //    nexusPassword=your-password
        // 2. ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ ì„¤ì •:
        //    export NEXUS_USERNAME=your-username
        //    export NEXUS_PASSWORD=your-password
        // 3. URLì„ íšŒì‚¬ Nexus ì„œë²„ ì£¼ì†Œë¡œ ë³€ê²½
        // ========================================================
    }
}

// ì„œë¸Œí”„ë¡œì íŠ¸ì—ë§Œ ì ìš©ë˜ëŠ” ì„¤ì •
subprojects {
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    
    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(21)
        }
    }
    
    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }
    
    ext {
        set('springCloudVersion', "2024.0.0")
    }
    
    // ê³µí†µ ì˜ì¡´ì„± ì„¤ì •
    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-web'
        implementation 'org.springframework.boot:spring-boot-starter-actuator'
        implementation 'org.springframework.boot:spring-boot-starter-validation'
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        implementation 'com.h2database:h2'
        
        // AWS SQS
        implementation 'io.awspring.cloud:spring-cloud-aws-starter-sqs'
        implementation 'software.amazon.awssdk:sqs'
        
        // JSON Processing
        implementation 'com.fasterxml.jackson.core:jackson-databind'
        implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'
        
        // Observability
        implementation 'io.micrometer:micrometer-registry-prometheus'
        
        compileOnly 'org.projectlombok:lombok'
        annotationProcessor 'org.projectlombok:lombok'
        
        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'org.springframework.boot:spring-boot-testcontainers'
        testImplementation 'io.awspring.cloud:spring-cloud-aws-testcontainers'
        testImplementation 'org.testcontainers:junit-jupiter'
        testImplementation 'org.testcontainers:localstack'
        testImplementation 'com.amazonaws:aws-java-sdk-sqs:1.12.756'
        testImplementation 'org.awaitility:awaitility'
        testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    }
    
    dependencyManagement {
        imports {
            mavenBom "io.awspring.cloud:spring-cloud-aws-dependencies:3.2.1"
            mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
        }
    }
    
    // ê³µí†µ í…ŒìŠ¤íŠ¸ ì„¤ì •
    tasks.named('test') {
        useJUnitPlatform {
            excludeTags 'integration'
        }
        systemProperty 'spring.profiles.active', 'test'
    }
    
    tasks.register('integrationTest', Test) {
        useJUnitPlatform {
            includeTags 'integration'
        }
        description = 'Runs integration tests.'
        group = 'verification'
        shouldRunAfter test
        
        // Colima Docker support
        systemProperty 'spring.profiles.active', 'test'
        environment 'DOCKER_HOST', 'unix://' + System.getProperty('user.home') + '/.colima/default/docker.sock'
        environment 'TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE', '/var/run/docker.sock'
        systemProperty 'testcontainers.dockersocket.override', System.getProperty('user.home') + '/.colima/default/docker.sock'
    }
    
    check.dependsOn integrationTest
    
    // ========================================================
    // ğŸ“¤ Nexus Publishing ì„¤ì • (íŒ¨í‚¤ì§€ ë°°í¬)
    // ========================================================
    // ì‚¬ë‚´ Nexusì— íŒ¨í‚¤ì§€ë¥¼ ë°°í¬í•˜ëŠ” ê²½ìš° ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ê³  ì„¤ì •:
    /*
    apply plugin: 'maven-publish'
    
    publishing {
        publications {
            maven(MavenPublication) {
                from components.java
                
                pom {
                    name = project.name
                    description = project.description
                    packaging = 'jar'
                }
            }
        }
        
        repositories {
            maven {
                name = "nexus"
                def releasesRepoUrl = "http://your-nexus-server:8081/repository/maven-releases/"  // ğŸ‘ˆ íšŒì‚¬ Nexus URLë¡œ ë³€ê²½
                def snapshotsRepoUrl = "http://your-nexus-server:8081/repository/maven-snapshots/"  // ğŸ‘ˆ íšŒì‚¬ Nexus URLë¡œ ë³€ê²½
                url = version.endsWith('SNAPSHOT') ? snapshotsRepoUrl : releasesRepoUrl
                allowInsecureProtocol = true  // HTTP ì‚¬ìš© ì‹œ (HTTPS ê¶Œì¥)
                credentials {
                    username = project.findProperty("nexusUsername") ?: System.getenv("NEXUS_USERNAME")
                    password = project.findProperty("nexusPassword") ?: System.getenv("NEXUS_PASSWORD")
                }
            }
        }
    }
    */
    
    // ğŸ“‹ Nexus Publishing ì‚¬ìš© ë°©ë²•:
    // 1. ìœ„ì˜ ì£¼ì„ì„ í•´ì œí•˜ê³  URLì„ íšŒì‚¬ Nexusë¡œ ë³€ê²½
    // 2. íŒ¨í‚¤ì§€ ë°°í¬ ëª…ë ¹ì–´:
    //    ./gradlew publish  (ëª¨ë“  ëª¨ë“ˆ ë°°í¬)
    //    ./gradlew :producer-service:publish  (Producerë§Œ ë°°í¬)
    //    ./gradlew :consumer-service:publish  (Consumerë§Œ ë°°í¬)
    // 3. ë²„ì „ ê´€ë¦¬:
    //    - SNAPSHOT: ê°œë°œ ì¤‘ì¸ ë²„ì „ (ìë™ìœ¼ë¡œ snapshots ì €ì¥ì†Œì— ë°°í¬)
    //    - RELEASE: ì •ì‹ ë²„ì „ (releases ì €ì¥ì†Œì— ë°°í¬)
    // ========================================================
}

// ì „ì²´ ì„œë¹„ìŠ¤ ë™ì‹œ ì‹¤í–‰ íƒœìŠ¤í¬
task startAllServices {
    group = 'application'
    description = 'Producerì™€ Consumer ì„œë¹„ìŠ¤ë¥¼ ë™ì‹œì— ì‹¤í–‰í•©ë‹ˆë‹¤'
    
    doLast {
        println '''
===========================================
ğŸš€ ë‘ ì„œë¹„ìŠ¤ë¥¼ ë™ì‹œì— ì‹œì‘í•©ë‹ˆë‹¤...
===========================================
Producer Service: http://localhost:8080
Consumer Service:  http://localhost:8081
LocalStack SQS:    http://localhost:4566
===========================================
ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ë ¤ë©´ Ctrl+Cë¥¼ ëˆ„ë¥´ì„¸ìš”
===========================================
        '''
    }
}

// ë³‘ë ¬ ì‹¤í–‰ì„ ìœ„í•œ ê°œë³„ íƒœìŠ¤í¬
task startProducer {
    group = 'application'
    description = 'Producer ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤'
    dependsOn ':producer-service:bootRun'
}

task startConsumer {
    group = 'application'  
    description = 'Consumer ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤'
    dependsOn ':consumer-service:bootRun'
}

// startAllServicesê°€ ë³‘ë ¬ë¡œ ë‘ ì„œë¹„ìŠ¤ ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •
startAllServices.dependsOn startProducer, startConsumer

// ë³‘ë ¬ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
tasks.configureEach {
    if (it.name in ['startProducer', 'startConsumer']) {
        it.setMustRunAfter([])
    }
}

// Wrapper íƒœìŠ¤í¬ ì„¤ì •
wrapper {
    gradleVersion = '8.10'
    distributionType = Wrapper.DistributionType.ALL
}